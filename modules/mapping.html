<!doctype html>
<html lang="en-US">
  <head>
    <meta charset="utf-8">
<meta http-equiv="X-UA-Compatible" content="chrome=1">
<meta name="viewport" content="width=device-width">
<link rel="stylesheet" href="/rworkshop/assets/css/style.css">
<link rel="stylesheet" href="/rworkshop/assets/css/syntax_default.css">
<link rel="stylesheet" href="/rworkshop/assets/leaflet/leaflet.css" />
<script defer src="/rworkshop/assets/js/fontawesome-all.js"></script>
<!--[if lt IE 9]>
    <script src="//html5shiv.googlecode.com/svn/trunk/html5.js"></script>
    <![endif]-->
<script type="text/javascript" async
	src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.4/MathJax.js?config=TeX-MML-AM_CHTML">
</script>


  </head>
  <body>
    <div class="wrapper">
      <header>
        <h1>Workshop on R<a href="https://github.com/btskinner/rworkshop" class="iconlink">
	      <i class="fab fa-github fa-xs"></i></a></h1>
	<h2 class="thin">May 2018</h2>
	<p>Hosted by Virginia Education Science Training (VEST) Program at UVA</p>
	
        <p>
	  <a href="https://curry.virginia.edu/faculty-research/centers-labs-projects/edpolicyworks">
	    <img src="https://curry.virginia.edu/sites/default/files/uploads/epw/EdPolicyWork%20horz%20logo%20high%20res.png" style="width:100%;">
	  </a>
	</p>
	<h2 class="thin">
	  <a href="/rworkshop/">Overview</a></br>
	  <a href="/rworkshop/schedule/">Schedule</a></br>
	  <a href="/rworkshop/start/">Getting started</a></br>
	  <a href="/rworkshop/modules/">Modules</a></br>
	  <a href="/rworkshop/data/">Data</a></br>
	</h2>
      </header>

      <section>

      <h1>Mapping in R</h1>


<p>
  
  <a href="/rworkshop/scripts/mapping.R"
     class="iconlink" download title="Get script">
    <i class="fas fa-code fa-2x"></i>
  </a>
  &nbsp;&nbsp;
  
  
  
  
</p>


<p>This module will show some basic mapping tasks, including merging
geospatial data and making an interactive
<a href="https://leafletjs.com">Leaflet</a> map. We’ll use spatial data from the
<a href="http://opendata.charlottesville.org">Charlottesville, VA, open data
portal</a>, which will also give us
practice using APIs.</p>

<h2 id="requirements">Requirements</h2>

<p>Even though ggplot2 is a part of the tidyverse suite of packages, you
will need to download the development version of ggplot2 from GitHub in
order to plot maps using the new
<a href="https://CRAN.R-project.org/package=sf">sf</a> package. Use the
<a href="https://CRAN.R-project.org/package=devtools">devtools</a> package to get
it:</p>

<div class="language-r highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c1">## get development version of ggplot2 if needed</span><span class="w">
</span><span class="n">devtools</span><span class="o">::</span><span class="n">install_github</span><span class="p">(</span><span class="s1">'tidyverse/ggplot2'</span><span class="p">)</span><span class="w">
</span></code></pre></div></div>

<p>You may also need to install the following libraries on your computer:</p>

<ul>
  <li><a href="http://trac.osgeo.org/gdal/wiki/DownloadSource">GDAL</a></li>
  <li><a href="https://trac.osgeo.org/geos/">GEOS</a></li>
  <li><a href="http://download.osgeo.org/proj/">PROJ.4</a></li>
</ul>

<p>MacOS users can get these libraries (GDAL Complete) from
<a href="http://www.kyngchaos.com/software/frameworks">here</a>.</p>

<div class="language-r highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c1">## libraries</span><span class="w">
</span><span class="n">libs</span><span class="w"> </span><span class="o">&lt;-</span><span class="w"> </span><span class="nf">c</span><span class="p">(</span><span class="s1">'tidyverse'</span><span class="p">,</span><span class="s1">'leaflet'</span><span class="p">,</span><span class="s1">'sf'</span><span class="p">,</span><span class="s1">'RColorBrewer'</span><span class="p">)</span><span class="w">
</span><span class="n">lapply</span><span class="p">(</span><span class="n">libs</span><span class="p">,</span><span class="w"> </span><span class="n">require</span><span class="p">,</span><span class="w"> </span><span class="n">character.only</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="kc">TRUE</span><span class="p">)</span><span class="w">
</span></code></pre></div></div>

<h1 id="quick-api-function">Quick API function</h1>

<p>Inspecting the API string used to make a data request, the format across
data sets is fairly regular with a few variations. Though it’s probably
overkill to write a function (and we could probably write a cleaner
one), rewriting the API string over and over again also seems tedious
and error prone.</p>

<p>So here’s function that requires the map server number, the open data
number (which is 1 for both our data sets), and a string vector of the
variables we want, with the default being all of them. We still need to
use the open data portal to figure out what arguments we need to provide
for each data set, but the function will make us a nice API string that
we won’t need to build ourselves.</p>

<div class="language-r highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c1">## quick function to help use Charlottesville API</span><span class="w">
</span><span class="n">cville_api_url</span><span class="w"> </span><span class="o">&lt;-</span><span class="w"> </span><span class="k">function</span><span class="p">(</span><span class="n">mapserver_number</span><span class="p">,</span><span class="w">
                           </span><span class="n">open_data_number</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="m">1</span><span class="p">,</span><span class="w">
                           </span><span class="n">variable_vector</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nf">c</span><span class="p">(</span><span class="s1">'*'</span><span class="p">))</span><span class="w"> </span><span class="p">{</span><span class="w">
    </span><span class="n">base</span><span class="w"> </span><span class="o">&lt;-</span><span class="w"> </span><span class="n">paste0</span><span class="p">(</span><span class="s1">'https://gisweb.charlottesville.org/'</span><span class="p">,</span><span class="w">
                   </span><span class="s1">'arcgis/rest/services/OpenData_'</span><span class="p">,</span><span class="w">
                   </span><span class="n">open_data_number</span><span class="p">,</span><span class="w">
                   </span><span class="s1">'/MapServer/'</span><span class="p">)</span><span class="w">
    </span><span class="n">mid</span><span class="w"> </span><span class="o">&lt;-</span><span class="w"> </span><span class="s1">'/query?where=1%3D1&amp;outFields='</span><span class="w">
    </span><span class="n">var</span><span class="w"> </span><span class="o">&lt;-</span><span class="w"> </span><span class="n">paste</span><span class="p">(</span><span class="n">variable_vector</span><span class="p">,</span><span class="w"> </span><span class="n">collapse</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s1">','</span><span class="p">)</span><span class="w">
    </span><span class="n">end</span><span class="w"> </span><span class="o">&lt;-</span><span class="w"> </span><span class="s1">'&amp;outSR=4326&amp;f=json'</span><span class="w">
    </span><span class="nf">return</span><span class="p">(</span><span class="n">paste0</span><span class="p">(</span><span class="n">base</span><span class="p">,</span><span class="w"> </span><span class="n">mapserver_number</span><span class="p">,</span><span class="w"> </span><span class="n">mid</span><span class="p">,</span><span class="w"> </span><span class="n">var</span><span class="p">,</span><span class="w"> </span><span class="n">end</span><span class="p">))</span><span class="w">
</span><span class="p">}</span><span class="w">
</span></code></pre></div></div>

<h1 id="request-data">Request data</h1>

<p>First, we’ll get spatial data for the six elementary school catchments
zones in Charlottesville. These only come with the zone name, so we’ll
request all variables.</p>

<div class="language-r highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c1">## get school link</span><span class="w">
</span><span class="n">sch_link</span><span class="w"> </span><span class="o">&lt;-</span><span class="w"> </span><span class="n">cville_api_url</span><span class="p">(</span><span class="n">mapserver_number</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="m">16</span><span class="p">)</span><span class="w">

</span><span class="c1">## get school data</span><span class="w">
</span><span class="n">sch</span><span class="w"> </span><span class="o">&lt;-</span><span class="w"> </span><span class="n">st_read</span><span class="p">(</span><span class="n">sch_link</span><span class="p">)</span><span class="w"> </span><span class="o">%&gt;%</span><span class="w">
    </span><span class="c1">## lower variable names</span><span class="w">
    </span><span class="n">setNames</span><span class="p">(</span><span class="n">tolower</span><span class="p">(</span><span class="nf">names</span><span class="p">(</span><span class="n">.</span><span class="p">)))</span><span class="w"> </span><span class="o">%&gt;%</span><span class="w">
    </span><span class="c1">## rename the unique id for later join</span><span class="w">
    </span><span class="n">rename</span><span class="p">(</span><span class="n">objectid_sch</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">objectid</span><span class="p">)</span><span class="w">
</span></code></pre></div></div>

<div class="highlighter-rouge"><div class="highlight"><pre class="highlight"><code>Reading layer `OGRGeoJSON' from data source `https://gisweb.charlottesville.org/arcgis/rest/services/OpenData_1/MapServer/16/query?where=1%3D1&amp;outFields=*&amp;outSR=4326&amp;f=json' using driver `GeoJSON'
Simple feature collection with 6 features and 2 fields
geometry type:  MULTIPOLYGON
dimension:      XY
bbox:           xmin: -78.52378 ymin: 38.00968 xmax: -78.44636 ymax: 38.07053
epsg (SRID):    4326
proj4string:    +proj=longlat +datum=WGS84 +no_defs
</code></pre></div></div>

<div class="language-r highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c1">## show</span><span class="w">
</span><span class="n">sch</span><span class="w">
</span></code></pre></div></div>

<div class="highlighter-rouge"><div class="highlight"><pre class="highlight"><code>Simple feature collection with 6 features and 2 fields
geometry type:  MULTIPOLYGON
dimension:      XY
bbox:           xmin: -78.52378 ymin: 38.00968 xmax: -78.44636 ymax: 38.07053
epsg (SRID):    4326
proj4string:    +proj=longlat +datum=WGS84 +no_defs
  objectid_sch          zone                       geometry
1            1 Burnley-Moran MULTIPOLYGON (((-78.46053 3...
2            2         Clark MULTIPOLYGON (((-78.47802 3...
3            3       Venable MULTIPOLYGON (((-78.47841 3...
4            4   Jackson-Via MULTIPOLYGON (((-78.49029 3...
5            5       Johnson MULTIPOLYGON (((-78.49289 3...
6            6    Greenbrier MULTIPOLYGON (((-78.47221 3...
</code></pre></div></div>

<p>Next, we’ll get census block spatial data. These data also include
population numbers broken out by demographics such as race / ethnicity.
<a href="https://www.theatlantic.com/education/archive/2018/03/school-segregation-is-not-a-myth/555614/">Because many public schools across the country remain largely
segregated by race in
2018</a>,
in practice if no longer by law, investigating the demographic make up
of school catchment zone remains an important task, particularly when
resource allocation and student outcomes are correlated with surrounding
population characteristics.</p>

<p>For this module, we’ll limit the census data to overall population
counts (2010) and available racial/ethnic subgroup counts.</p>

<div class="language-r highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c1">## get census block data link, with subset of variables</span><span class="w">
</span><span class="n">vars</span><span class="w"> </span><span class="o">&lt;-</span><span class="w"> </span><span class="nf">c</span><span class="p">(</span><span class="s1">'OBJECTID'</span><span class="p">,</span><span class="s1">'Block'</span><span class="p">,</span><span class="s1">'Population'</span><span class="p">,</span><span class="w">
          </span><span class="s1">'Hispanic_Origin'</span><span class="p">,</span><span class="s1">'NH_Wht'</span><span class="p">,</span><span class="s1">'NH_Blk'</span><span class="p">,</span><span class="w">
          </span><span class="s1">'NH_Ind'</span><span class="p">,</span><span class="s1">'NH_Asn'</span><span class="p">)</span><span class="w">
</span><span class="n">cba_link</span><span class="w"> </span><span class="o">&lt;-</span><span class="w"> </span><span class="n">cville_api_url</span><span class="p">(</span><span class="n">mapserver_number</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="m">13</span><span class="p">,</span><span class="w">
                           </span><span class="n">variable_vector</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">vars</span><span class="p">)</span><span class="w">

</span><span class="c1">## get census block data</span><span class="w">
</span><span class="n">cba</span><span class="w"> </span><span class="o">&lt;-</span><span class="w"> </span><span class="n">st_read</span><span class="p">(</span><span class="n">cba_link</span><span class="p">)</span><span class="w"> </span><span class="o">%&gt;%</span><span class="w">
    </span><span class="c1">## set names to lower</span><span class="w">
    </span><span class="n">setNames</span><span class="p">(</span><span class="n">tolower</span><span class="p">(</span><span class="nf">names</span><span class="p">(</span><span class="n">.</span><span class="p">)))</span><span class="w"> </span><span class="o">%&gt;%</span><span class="w">
    </span><span class="c1">## rename for later join and to make names clearer</span><span class="w">
    </span><span class="n">rename</span><span class="p">(</span><span class="n">objectid_cba</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">objectid</span><span class="p">,</span><span class="w">
           </span><span class="n">pop</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">population</span><span class="p">,</span><span class="w">      
           </span><span class="n">amerind</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">nh_ind</span><span class="p">,</span><span class="w">
           </span><span class="n">asian</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">nh_asn</span><span class="p">,</span><span class="w">
           </span><span class="n">black</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">nh_blk</span><span class="p">,</span><span class="w">
           </span><span class="n">hispanic</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">hispanic_origin</span><span class="p">,</span><span class="w">
           </span><span class="n">white</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">nh_wht</span><span class="p">)</span><span class="w"> </span><span class="o">%&gt;%</span><span class="w">
    </span><span class="c1">## create other race/ethnicity category</span><span class="w">
    </span><span class="n">mutate</span><span class="p">(</span><span class="n">other</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">pop</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="n">amerind</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="n">asian</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="n">black</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="n">hispanic</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="n">white</span><span class="p">)</span><span class="w">
</span></code></pre></div></div>

<div class="highlighter-rouge"><div class="highlight"><pre class="highlight"><code>Reading layer `OGRGeoJSON' from data source `https://gisweb.charlottesville.org/arcgis/rest/services/OpenData_1/MapServer/13/query?where=1%3D1&amp;outFields=OBJECTID,Block,Population,Hispanic_Origin,NH_Wht,NH_Blk,NH_Ind,NH_Asn&amp;outSR=4326&amp;f=json' using driver `GeoJSON'
Simple feature collection with 803 features and 8 fields
geometry type:  POLYGON
dimension:      XY
bbox:           xmin: -78.52364 ymin: 38.00959 xmax: -78.44631 ymax: 38.0706
epsg (SRID):    4326
proj4string:    +proj=longlat +datum=WGS84 +no_defs
</code></pre></div></div>

<div class="language-r highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c1">## show</span><span class="w">
</span><span class="n">cba</span><span class="w">
</span></code></pre></div></div>

<div class="highlighter-rouge"><div class="highlight"><pre class="highlight"><code>Simple feature collection with 803 features and 9 fields
geometry type:  POLYGON
dimension:      XY
bbox:           xmin: -78.52364 ymin: 38.00959 xmax: -78.44631 ymax: 38.0706
epsg (SRID):    4326
proj4string:    +proj=longlat +datum=WGS84 +no_defs
First 10 features:
   objectid_cba           block pop hispanic white black amerind asian
1             1 515400006002011 377       16   166    28       0   144
2             2 515400006002012   0        0     0     0       0     0
3             3 515400006002006  10        2     8     0       0     0
4             4 515400006002005   2        0     2     0       0     0
5             5 515400006002004 195       17    91    28       0    54
6             6 515400006002003  62        2    47     2       0    11
7             7 515400006002002 425       14   177    30       0   193
8             8 515400006002001  99        3    81     2       0    12
9             9 515400006002000 119        3    76     4       0    31
10           10 515400007004017   0        0     0     0       0     0
   other                       geometry
1     23 POLYGON ((-78.51184 38.0262...
2      0 POLYGON ((-78.51238 38.0269...
3      0 POLYGON ((-78.51974 38.0284...
4      0 POLYGON ((-78.51964 38.0289...
5      5 POLYGON ((-78.51939 38.0284...
6      0 POLYGON ((-78.5165 38.02864...
7     11 POLYGON ((-78.51447 38.0287...
8      1 POLYGON ((-78.5126 38.02695...
9      5 POLYGON ((-78.51218 38.0272...
10     0 POLYGON ((-78.51627 38.0403...
</code></pre></div></div>

<h1 id="elementary-attendance-zones">Elementary attendance zones</h1>

<p>As a first step, let’s plot the elementary school catchment zones using
leaflet. Since we don’t care about the displayed color of each zone
other than they be different to show separation between each, we’ll set
up a <code class="highlighter-rouge">colorFactor()</code> palette that we’ll then use with the <code class="highlighter-rouge">fillColor</code>
argument in <code class="highlighter-rouge">addPolygons()</code>.</p>

<p>Notice how the leaflet functions can be piped together like dplyr
functions. Also notice how arguments that vary by group use a tilde,
<code class="highlighter-rouge">~</code>, in front of the argument: <code class="highlighter-rouge">~factpal(sch$zone)</code> and <code class="highlighter-rouge">label = ~zone</code>.</p>

<div class="language-r highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c1">## set up color palette that will align</span><span class="w">
</span><span class="n">factpal</span><span class="w"> </span><span class="o">&lt;-</span><span class="w"> </span><span class="n">colorFactor</span><span class="p">(</span><span class="n">palette</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">brewer.pal</span><span class="p">(</span><span class="n">n</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nf">length</span><span class="p">(</span><span class="n">sch</span><span class="o">$</span><span class="n">zone</span><span class="p">),</span><span class="w">
                                            </span><span class="n">name</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s1">'Accent'</span><span class="p">),</span><span class="w">
                       </span><span class="n">domain</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">as.factor</span><span class="p">(</span><span class="n">sch</span><span class="o">$</span><span class="n">zone</span><span class="p">))</span><span class="w">

</span><span class="c1">## make leaflet map</span><span class="w">
</span><span class="n">map</span><span class="w"> </span><span class="o">&lt;-</span><span class="w"> </span><span class="n">leaflet</span><span class="p">(</span><span class="n">sch</span><span class="p">)</span><span class="w"> </span><span class="o">%&gt;%</span><span class="w">
    </span><span class="n">addProviderTiles</span><span class="p">(</span><span class="n">providers</span><span class="o">$</span><span class="n">CartoDB.Positron</span><span class="p">)</span><span class="w"> </span><span class="o">%&gt;%</span><span class="w">
    </span><span class="n">addPolygons</span><span class="p">(</span><span class="n">color</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s1">'black'</span><span class="p">,</span><span class="w"> </span><span class="n">weight</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="m">2</span><span class="p">,,</span><span class="w"> </span><span class="n">fillOpacity</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="m">.5</span><span class="p">,</span><span class="w">
                </span><span class="n">fillColor</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="o">~</span><span class="n">factpal</span><span class="p">(</span><span class="n">sch</span><span class="o">$</span><span class="n">zone</span><span class="p">),</span><span class="w"> </span><span class="n">label</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="o">~</span><span class="n">zone</span><span class="p">)</span><span class="w">
</span><span class="n">map</span><span class="w">
</span></code></pre></div></div>

<!--html_preserve-->

<iframe src="./maps/maps/map_sch.html">

</iframe>

<!--/html_preserve-->

<h1 id="census-block-areas">Census block areas</h1>

<p>Next, let’s map the census block areas. Again, we just want to show the
different areas, so the assigned color will just be a random sample of
colors.</p>

<div class="language-r highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c1">## too many census blocks so will randomly assign indices for colors</span><span class="w">
</span><span class="n">cba</span><span class="o">$</span><span class="n">group</span><span class="w"> </span><span class="o">&lt;-</span><span class="w"> </span><span class="n">factor</span><span class="p">(</span><span class="n">sample.int</span><span class="p">(</span><span class="m">11L</span><span class="p">,</span><span class="w"> </span><span class="n">nrow</span><span class="p">(</span><span class="n">cba</span><span class="p">),</span><span class="w"> </span><span class="n">replace</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="kc">TRUE</span><span class="p">))</span><span class="w">

</span><span class="c1">## set up color palette that will align with indices</span><span class="w">
</span><span class="n">factpal</span><span class="w"> </span><span class="o">&lt;-</span><span class="w"> </span><span class="n">colorFactor</span><span class="p">(</span><span class="n">palette</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">brewer.pal</span><span class="p">(</span><span class="n">n</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="m">8L</span><span class="p">,</span><span class="w"> </span><span class="n">name</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s1">'Accent'</span><span class="p">),</span><span class="w">
                       </span><span class="n">domain</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">cba</span><span class="o">$</span><span class="n">group</span><span class="p">)</span><span class="w">

</span><span class="c1">## make leaflet map</span><span class="w">
</span><span class="n">map</span><span class="w"> </span><span class="o">&lt;-</span><span class="w"> </span><span class="n">leaflet</span><span class="p">(</span><span class="n">cba</span><span class="p">)</span><span class="w"> </span><span class="o">%&gt;%</span><span class="w">
    </span><span class="n">addProviderTiles</span><span class="p">(</span><span class="n">providers</span><span class="o">$</span><span class="n">CartoDB.Positron</span><span class="p">)</span><span class="w"> </span><span class="o">%&gt;%</span><span class="w">
    </span><span class="n">addPolygons</span><span class="p">(</span><span class="n">color</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s1">'black'</span><span class="p">,</span><span class="w"> </span><span class="n">weight</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="m">2</span><span class="p">,</span><span class="w"> </span><span class="n">fillOpacity</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="m">.5</span><span class="p">,</span><span class="w">
                </span><span class="n">fillColor</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="o">~</span><span class="n">factpal</span><span class="p">(</span><span class="n">cba</span><span class="o">$</span><span class="n">group</span><span class="p">),</span><span class="w"> </span><span class="n">label</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="o">~</span><span class="n">block</span><span class="p">)</span><span class="w">
</span><span class="n">map</span><span class="w">
</span></code></pre></div></div>

<!--html_preserve-->

<iframe src="./maps/maps/map_cba.html">

</iframe>

<!--/html_preserve-->

<h1 id="merging-spatial-data">Merging spatial data</h1>

<p>Here’s our problem: the demographic data in the census blocks needs to
be aggregated up to the school zone areas. To attach census data to
school zones for further analysis, we need to join the spatial data.</p>

<p>This used to be a bit difficult, but the <code class="highlighter-rouge">st_intersection()</code> function
from the <code class="highlighter-rouge">sf</code> package makes this join much easier.</p>

<div class="language-r highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c1">## merge polygons</span><span class="w">
</span><span class="n">cba_sch</span><span class="w"> </span><span class="o">&lt;-</span><span class="w"> </span><span class="n">st_intersection</span><span class="p">(</span><span class="n">cba</span><span class="p">,</span><span class="w"> </span><span class="n">sch</span><span class="p">)</span><span class="w">
</span></code></pre></div></div>

<div class="highlighter-rouge"><div class="highlight"><pre class="highlight"><code>although coordinates are longitude/latitude, st_intersection assumes that they are planar

Warning: attribute variables are assumed to be spatially constant
throughout all geometries
</code></pre></div></div>

<p>That said, the merge isn’t perfect because the underlying spatial data
don’t perfectly align.</p>

<blockquote>
  <h4 id="quick-exercise">Quick exercise</h4>

  <p>Check the row counts of the census block data frame and the newly
merged data frame. How many extra rows are there in the new data
frame?</p>
</blockquote>

<p>Our new data set is larger than the number of census blocks because the
<code class="highlighter-rouge">st_intersection()</code> function performs a full join, making a row for each
overlap. For census blocks entirely inside one zone, there’s just one
row. But for census blocks that split across more than one district,
there is a row for each zone - block combination.</p>

<p>Let’s zoom in on an example overlap.</p>

<div class="language-r highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c1">## ---------------------------------------------</span><span class="w">
</span><span class="c1">## plot one zone as example, making an inset map</span><span class="w">
</span><span class="c1">## ---------------------------------------------</span><span class="w">

</span><span class="c1">## primary zoomed in map</span><span class="w">
</span><span class="n">g</span><span class="m">1</span><span class="w"> </span><span class="o">&lt;-</span><span class="w"> </span><span class="n">ggplot</span><span class="p">(</span><span class="n">sch</span><span class="p">)</span><span class="w"> </span><span class="o">+</span><span class="w">
    </span><span class="n">geom_sf</span><span class="p">()</span><span class="w"> </span><span class="o">+</span><span class="w">
    </span><span class="n">geom_sf</span><span class="p">(</span><span class="n">aes</span><span class="p">(</span><span class="n">fill</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">factor</span><span class="p">(</span><span class="n">zone</span><span class="p">)),</span><span class="w"> </span><span class="n">color</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="kc">NA</span><span class="p">,</span><span class="w">
            </span><span class="n">data</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">cba_sch</span><span class="w"> </span><span class="o">%&gt;%</span><span class="w"> </span><span class="n">filter</span><span class="p">(</span><span class="n">objectid_cba</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="m">28</span><span class="p">))</span><span class="w"> </span><span class="o">+</span><span class="w">
    </span><span class="n">coord_sf</span><span class="p">(</span><span class="n">xlim</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nf">c</span><span class="p">(</span><span class="m">-78.514</span><span class="p">,</span><span class="w"> </span><span class="m">-78.5035</span><span class="p">),</span><span class="w"> </span><span class="n">ylim</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nf">c</span><span class="p">(</span><span class="m">38.015</span><span class="p">,</span><span class="w"> </span><span class="m">38.023</span><span class="p">))</span><span class="w"> </span><span class="o">+</span><span class="w">
    </span><span class="n">guides</span><span class="p">(</span><span class="n">fill</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">guide_legend</span><span class="p">(</span><span class="n">title</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s1">'School Zone'</span><span class="p">))</span><span class="w"> 

</span><span class="c1">## whole Charlottesville map for inset, just wrap in ggplotGlob()</span><span class="w">
</span><span class="n">g</span><span class="m">2</span><span class="w"> </span><span class="o">&lt;-</span><span class="w"> </span><span class="n">ggplotGrob</span><span class="p">(</span><span class="w">
    </span><span class="n">ggplot</span><span class="p">(</span><span class="n">sch</span><span class="p">)</span><span class="w"> </span><span class="o">+</span><span class="w">
    </span><span class="n">geom_sf</span><span class="p">()</span><span class="w"> </span><span class="o">+</span><span class="w">
    </span><span class="n">geom_sf</span><span class="p">(</span><span class="n">aes</span><span class="p">(</span><span class="n">fill</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">factor</span><span class="p">(</span><span class="n">zone</span><span class="p">)),</span><span class="w"> 
            </span><span class="n">data</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">cba_sch</span><span class="w"> </span><span class="o">%&gt;%</span><span class="w"> </span><span class="n">filter</span><span class="p">(</span><span class="n">objectid_cba</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="m">28</span><span class="p">))</span><span class="w"> </span><span class="o">+</span><span class="w">
    </span><span class="n">theme</span><span class="p">(</span><span class="n">panel.background</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">element_rect</span><span class="p">(</span><span class="n">fill</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s1">'white'</span><span class="p">),</span><span class="w">
          </span><span class="n">legend.position</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s1">'none'</span><span class="p">,</span><span class="w">
          </span><span class="n">line</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">element_blank</span><span class="p">(),</span><span class="w">
          </span><span class="n">text</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">element_blank</span><span class="p">(),</span><span class="w">
          </span><span class="n">axis.ticks</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">element_blank</span><span class="p">(),</span><span class="w">
          </span><span class="n">panel.grid.major</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">element_line</span><span class="p">(</span><span class="n">colour</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s1">'white'</span><span class="p">),</span><span class="w">
          </span><span class="n">panel.grid.minor</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">element_blank</span><span class="p">())</span><span class="w">
</span><span class="p">)</span><span class="w">

</span><span class="c1">## combine and show</span><span class="w">
</span><span class="n">g</span><span class="m">3</span><span class="w"> </span><span class="o">&lt;-</span><span class="w"> </span><span class="n">g</span><span class="m">1</span><span class="w"> </span><span class="o">+</span><span class="w">
      </span><span class="n">annotation_custom</span><span class="p">(</span><span class="n">grob</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">g</span><span class="m">2</span><span class="p">,</span><span class="w"> </span><span class="n">xmin</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="m">-78.510</span><span class="p">,</span><span class="w"> </span><span class="n">xmax</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="m">-78.5018</span><span class="p">,</span><span class="w">
                        </span><span class="n">ymin</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="m">38.019</span><span class="p">,</span><span class="w"> </span><span class="n">ymax</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="m">38.0232</span><span class="p">)</span><span class="w">
</span><span class="n">g</span><span class="m">3</span><span class="w">
</span></code></pre></div></div>

<p><img src="figures/mapping_inset-1.png" width="100%" /></p>

<p>Overlaps like these pose a small problem for our calculations since not
everyone in some census blocks lives in the same school zone. Ideally,
we would have household information and be able to aggregate precisely.
But because census blocks are the smallest publicly available unit,
we’ll have to compromise.</p>

<p>An easy solution will be to figure out what proportion of each census
block is in each school zone. For most, it will be 100% inside a single
zone. For the overlapping blocks, we can use these proportions to make
weights that we’ll use when aggregating population counts.</p>

<p>For example if a census block is 10% in one zone and 90% in another, its
population counts will be given a weight of .1 in the first and .9 in
the second. Clearly this solution is imperfect, but it’s easy and will
get us a more accurate answer than some other quick solution (like a
majority decision where a block’s population counts go the zone in which
the majority of its area lies).</p>

<p>We’ll do this in three steps:</p>

<ol>
  <li>Get the area of each sub-part using <code class="highlighter-rouge">st_area()</code></li>
  <li>Get the area of each census block from the original <code class="highlighter-rouge">cba</code> object</li>
  <li>Join these data frames and compute a weight as sub area over full
area</li>
</ol>

<!-- end list -->

<div class="language-r highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c1">## 1. get sub group area</span><span class="w">
</span><span class="n">cba_sch</span><span class="w"> </span><span class="o">&lt;-</span><span class="w"> </span><span class="n">cba_sch</span><span class="w"> </span><span class="o">%&gt;%</span><span class="w">
    </span><span class="n">mutate</span><span class="p">(</span><span class="n">area</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">st_area</span><span class="p">(</span><span class="n">.</span><span class="p">)</span><span class="w"> </span><span class="o">%&gt;%</span><span class="w"> </span><span class="nf">as.numeric</span><span class="p">())</span><span class="w">

</span><span class="c1">## 2. get original areas of census blocks</span><span class="w">
</span><span class="n">cb_area</span><span class="w"> </span><span class="o">&lt;-</span><span class="w"> </span><span class="n">cba</span><span class="w"> </span><span class="o">%&gt;%</span><span class="w">
    </span><span class="n">mutate</span><span class="p">(</span><span class="n">area</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">st_area</span><span class="p">(</span><span class="n">.</span><span class="p">)</span><span class="w"> </span><span class="o">%&gt;%</span><span class="w"> </span><span class="nf">as.numeric</span><span class="p">())</span><span class="w"> </span><span class="o">%&gt;%</span><span class="w">
    </span><span class="n">select</span><span class="p">(</span><span class="n">block</span><span class="p">,</span><span class="w"> </span><span class="n">full_area</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">area</span><span class="p">)</span><span class="w"> </span><span class="o">%&gt;%</span><span class="w">
    </span><span class="n">st_set_geometry</span><span class="p">(</span><span class="kc">NULL</span><span class="p">)</span><span class="w">

</span><span class="c1">## 3. join and ...</span><span class="w">
</span><span class="n">cba_sch</span><span class="w"> </span><span class="o">&lt;-</span><span class="w"> </span><span class="n">cba_sch</span><span class="w"> </span><span class="o">%&gt;%</span><span class="w">
    </span><span class="n">left_join</span><span class="p">(</span><span class="n">cb_area</span><span class="p">)</span><span class="w"> </span><span class="o">%&gt;%</span><span class="w">
    </span><span class="c1">## ...compute fraction as weight</span><span class="w">
    </span><span class="n">mutate</span><span class="p">(</span><span class="n">prop_w</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">area</span><span class="w"> </span><span class="o">/</span><span class="w"> </span><span class="n">full_area</span><span class="p">)</span><span class="w">
</span></code></pre></div></div>

<div class="highlighter-rouge"><div class="highlight"><pre class="highlight"><code>Joining, by = "block"
</code></pre></div></div>

<p>Quickly, let’s check our example overlapping census block group to see
if it passes the sniff test.</p>

<div class="language-r highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c1">## check our example</span><span class="w">
</span><span class="n">cba_sch</span><span class="w"> </span><span class="o">%&gt;%</span><span class="w">
    </span><span class="n">select</span><span class="p">(</span><span class="n">block</span><span class="p">,</span><span class="w"> </span><span class="n">objectid_cba</span><span class="p">,</span><span class="w"> </span><span class="n">area</span><span class="p">,</span><span class="w"> </span><span class="n">full_area</span><span class="p">,</span><span class="w"> </span><span class="n">prop_w</span><span class="p">)</span><span class="w"> </span><span class="o">%&gt;%</span><span class="w">
    </span><span class="n">filter</span><span class="p">(</span><span class="n">objectid_cba</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="m">28</span><span class="p">)</span><span class="w"> </span><span class="o">%&gt;%</span><span class="w">
    </span><span class="n">st_set_geometry</span><span class="p">(</span><span class="kc">NULL</span><span class="p">)</span><span class="w">
</span></code></pre></div></div>

<div class="highlighter-rouge"><div class="highlight"><pre class="highlight"><code>            block objectid_cba     area full_area     prop_w
1 515400005024000           28 80607.96  83905.59 0.96069836
2 515400005024000           28  3297.62  83905.59 0.03930155
</code></pre></div></div>

<p>Yep, a split of 94% and 6% seems reasonable based on the plot. Forward!</p>

<blockquote>
  <h4 id="quick-ish-exercise">Quick-ish exercise</h4>

  <p>Find another overlapping census block and</p>

  <ol>
    <li>Map it like above (may have to fiddle w/annotation placement)</li>
    <li>See if computed proportions match visual</li>
  </ol>
</blockquote>

<h1 id="aggregate-demographics-within-each-elementary-school-zone">Aggregate demographics within each elementary school zone</h1>

<p>Now that we’ve joined our census block and school zone data and computed
weights, we can aggregate population counts to each school
zone.</p>

<div class="language-r highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c1">## get aggregate population counts (weighted by proportion of block in zone)</span><span class="w">
</span><span class="n">sch_pop</span><span class="w"> </span><span class="o">&lt;-</span><span class="w"> </span><span class="n">cba_sch</span><span class="w"> </span><span class="o">%&gt;%</span><span class="w">
    </span><span class="n">group_by</span><span class="p">(</span><span class="n">objectid_sch</span><span class="p">)</span><span class="w"> </span><span class="o">%&gt;%</span><span class="w">
    </span><span class="c1">## weighted counts...</span><span class="w">
    </span><span class="n">summarise</span><span class="p">(</span><span class="n">amerind</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nf">round</span><span class="p">(</span><span class="nf">sum</span><span class="p">(</span><span class="n">amerind</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="n">prop_w</span><span class="p">)),</span><span class="w">
              </span><span class="n">asian</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nf">round</span><span class="p">(</span><span class="nf">sum</span><span class="p">(</span><span class="n">asian</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="n">prop_w</span><span class="p">)),</span><span class="w">
              </span><span class="n">black</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nf">round</span><span class="p">(</span><span class="nf">sum</span><span class="p">(</span><span class="n">black</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="n">prop_w</span><span class="p">)),</span><span class="w">
              </span><span class="n">hispanic</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nf">round</span><span class="p">(</span><span class="nf">sum</span><span class="p">(</span><span class="n">hispanic</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="n">prop_w</span><span class="p">)),</span><span class="w">
              </span><span class="n">other</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nf">round</span><span class="p">(</span><span class="nf">sum</span><span class="p">(</span><span class="n">other</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="n">prop_w</span><span class="p">)),</span><span class="w">
              </span><span class="n">white</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nf">round</span><span class="p">(</span><span class="nf">sum</span><span class="p">(</span><span class="n">white</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="n">prop_w</span><span class="p">)))</span><span class="w"> </span><span class="o">%&gt;%</span><span class="w">
    </span><span class="c1">## ...then total...</span><span class="w">
    </span><span class="n">mutate</span><span class="p">(</span><span class="n">pop</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">amerind</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="n">asian</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="n">black</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="n">hispanic</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="n">other</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="n">white</span><span class="p">,</span><span class="w">
           </span><span class="c1">## ...then proportion</span><span class="w">
           </span><span class="n">amerinc_pct</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">amerind</span><span class="w"> </span><span class="o">/</span><span class="w"> </span><span class="n">pop</span><span class="p">,</span><span class="w">
           </span><span class="n">asian_pct</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">asian</span><span class="w"> </span><span class="o">/</span><span class="w"> </span><span class="n">pop</span><span class="p">,</span><span class="w">
           </span><span class="n">black_pct</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">black</span><span class="w"> </span><span class="o">/</span><span class="w"> </span><span class="n">pop</span><span class="p">,</span><span class="w">
           </span><span class="n">hispanic_pct</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">hispanic</span><span class="w"> </span><span class="o">/</span><span class="w"> </span><span class="n">pop</span><span class="p">,</span><span class="w">
           </span><span class="n">other_pct</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">other</span><span class="w"> </span><span class="o">/</span><span class="w"> </span><span class="n">pop</span><span class="p">,</span><span class="w">
           </span><span class="n">white_pct</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">white</span><span class="w"> </span><span class="o">/</span><span class="w"> </span><span class="n">pop</span><span class="p">)</span><span class="w"> </span><span class="o">%&gt;%</span><span class="w">
    </span><span class="n">st_set_geometry</span><span class="p">(</span><span class="kc">NULL</span><span class="p">)</span><span class="w">

</span><span class="c1">## join with school spatial data</span><span class="w">
</span><span class="n">sch</span><span class="w"> </span><span class="o">&lt;-</span><span class="w"> </span><span class="n">sch</span><span class="w"> </span><span class="o">%&gt;%</span><span class="w"> </span><span class="n">left_join</span><span class="p">(</span><span class="n">sch_pop</span><span class="p">)</span><span class="w">
</span></code></pre></div></div>

<div class="highlighter-rouge"><div class="highlight"><pre class="highlight"><code>Joining, by = "objectid_sch"
</code></pre></div></div>

<p>Let’s map it. For comparison, we’ll make four maps:</p>

<ol>
  <li>% Black population</li>
  <li>% Hispanic population</li>
  <li>% Asian population</li>
  <li>% White population</li>
</ol>

<!-- end list -->

<div class="language-r highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c1">## make leaflet map: % Black population</span><span class="w">
</span><span class="n">binpal</span><span class="w"> </span><span class="o">&lt;-</span><span class="w"> </span><span class="n">colorBin</span><span class="p">(</span><span class="s1">'Reds'</span><span class="p">,</span><span class="w"> </span><span class="n">sch</span><span class="o">$</span><span class="n">black_pct</span><span class="p">,</span><span class="w"> </span><span class="m">6</span><span class="p">)</span><span class="w">
</span><span class="n">map_bl_pct</span><span class="w"> </span><span class="o">&lt;-</span><span class="w"> </span><span class="n">leaflet</span><span class="p">(</span><span class="n">sch</span><span class="p">)</span><span class="w"> </span><span class="o">%&gt;%</span><span class="w">
    </span><span class="n">addProviderTiles</span><span class="p">(</span><span class="n">providers</span><span class="o">$</span><span class="n">CartoDB.Positron</span><span class="p">)</span><span class="w"> </span><span class="o">%&gt;%</span><span class="w">
    </span><span class="n">addPolygons</span><span class="p">(</span><span class="n">color</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s1">'black'</span><span class="p">,</span><span class="w"> </span><span class="n">weight</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="m">2</span><span class="p">,,</span><span class="w"> </span><span class="n">fillOpacity</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="m">.5</span><span class="p">,</span><span class="w">
                </span><span class="n">fillColor</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="o">~</span><span class="n">binpal</span><span class="p">(</span><span class="n">black_pct</span><span class="p">))</span><span class="w"> </span><span class="o">%&gt;%</span><span class="w">
    </span><span class="n">addLegend</span><span class="p">(</span><span class="s1">'topright'</span><span class="p">,</span><span class="w"> </span><span class="n">pal</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">binpal</span><span class="p">,</span><span class="w"> </span><span class="n">values</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="o">~</span><span class="n">black_pct</span><span class="p">,</span><span class="w">
              </span><span class="n">title</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s1">'% Black population (2010)'</span><span class="p">)</span><span class="w">

</span><span class="c1">## make leaflet map: % Hispanic population</span><span class="w">
</span><span class="n">binpal</span><span class="w"> </span><span class="o">&lt;-</span><span class="w"> </span><span class="n">colorBin</span><span class="p">(</span><span class="s1">'Reds'</span><span class="p">,</span><span class="w"> </span><span class="n">sch</span><span class="o">$</span><span class="n">hispanic_pct</span><span class="p">,</span><span class="w"> </span><span class="m">6</span><span class="p">)</span><span class="w">
</span><span class="n">map_hi_pct</span><span class="w"> </span><span class="o">&lt;-</span><span class="w"> </span><span class="n">leaflet</span><span class="p">(</span><span class="n">sch</span><span class="p">)</span><span class="w"> </span><span class="o">%&gt;%</span><span class="w">
    </span><span class="n">addProviderTiles</span><span class="p">(</span><span class="n">providers</span><span class="o">$</span><span class="n">CartoDB.Positron</span><span class="p">)</span><span class="w"> </span><span class="o">%&gt;%</span><span class="w">
    </span><span class="n">addPolygons</span><span class="p">(</span><span class="n">color</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s1">'black'</span><span class="p">,</span><span class="w"> </span><span class="n">weight</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="m">2</span><span class="p">,,</span><span class="w"> </span><span class="n">fillOpacity</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="m">.5</span><span class="p">,</span><span class="w">
                </span><span class="n">fillColor</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="o">~</span><span class="n">binpal</span><span class="p">(</span><span class="n">hispanic_pct</span><span class="p">))</span><span class="w"> </span><span class="o">%&gt;%</span><span class="w">
    </span><span class="n">addLegend</span><span class="p">(</span><span class="s1">'topright'</span><span class="p">,</span><span class="w"> </span><span class="n">pal</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">binpal</span><span class="p">,</span><span class="w"> </span><span class="n">values</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="o">~</span><span class="n">hispanic_pct</span><span class="p">,</span><span class="w">
              </span><span class="n">title</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s1">'% Hispanic population (2010)'</span><span class="p">)</span><span class="w">

</span><span class="c1">## make leaflet map: % Asian population</span><span class="w">
</span><span class="n">binpal</span><span class="w"> </span><span class="o">&lt;-</span><span class="w"> </span><span class="n">colorBin</span><span class="p">(</span><span class="s1">'Reds'</span><span class="p">,</span><span class="w"> </span><span class="n">sch</span><span class="o">$</span><span class="n">asian_pct</span><span class="p">,</span><span class="w"> </span><span class="m">6</span><span class="p">)</span><span class="w">
</span><span class="n">map_as_pct</span><span class="w"> </span><span class="o">&lt;-</span><span class="w"> </span><span class="n">leaflet</span><span class="p">(</span><span class="n">sch</span><span class="p">)</span><span class="w"> </span><span class="o">%&gt;%</span><span class="w">
    </span><span class="n">addProviderTiles</span><span class="p">(</span><span class="n">providers</span><span class="o">$</span><span class="n">CartoDB.Positron</span><span class="p">)</span><span class="w"> </span><span class="o">%&gt;%</span><span class="w">
    </span><span class="n">addPolygons</span><span class="p">(</span><span class="n">color</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s1">'black'</span><span class="p">,</span><span class="w"> </span><span class="n">weight</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="m">2</span><span class="p">,,</span><span class="w"> </span><span class="n">fillOpacity</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="m">.5</span><span class="p">,</span><span class="w">
                </span><span class="n">fillColor</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="o">~</span><span class="n">binpal</span><span class="p">(</span><span class="n">asian_pct</span><span class="p">))</span><span class="w"> </span><span class="o">%&gt;%</span><span class="w">
    </span><span class="n">addLegend</span><span class="p">(</span><span class="s1">'topright'</span><span class="p">,</span><span class="w"> </span><span class="n">pal</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">binpal</span><span class="p">,</span><span class="w"> </span><span class="n">values</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="o">~</span><span class="n">asian_pct</span><span class="p">,</span><span class="w">
              </span><span class="n">title</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s1">'% Asian population (2010)'</span><span class="p">)</span><span class="w">

</span><span class="c1">## make leaflet map: % White population</span><span class="w">
</span><span class="n">binpal</span><span class="w"> </span><span class="o">&lt;-</span><span class="w"> </span><span class="n">colorBin</span><span class="p">(</span><span class="s1">'Reds'</span><span class="p">,</span><span class="w"> </span><span class="n">sch</span><span class="o">$</span><span class="n">white_pct</span><span class="p">,</span><span class="w"> </span><span class="m">6</span><span class="p">)</span><span class="w">
</span><span class="n">map_wh_pct</span><span class="w"> </span><span class="o">&lt;-</span><span class="w"> </span><span class="n">leaflet</span><span class="p">(</span><span class="n">sch</span><span class="p">)</span><span class="w"> </span><span class="o">%&gt;%</span><span class="w">
    </span><span class="n">addProviderTiles</span><span class="p">(</span><span class="n">providers</span><span class="o">$</span><span class="n">CartoDB.Positron</span><span class="p">)</span><span class="w"> </span><span class="o">%&gt;%</span><span class="w">
    </span><span class="n">addPolygons</span><span class="p">(</span><span class="n">color</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s1">'black'</span><span class="p">,</span><span class="w"> </span><span class="n">weight</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="m">2</span><span class="p">,,</span><span class="w"> </span><span class="n">fillOpacity</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="m">.5</span><span class="p">,</span><span class="w">
                </span><span class="n">fillColor</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="o">~</span><span class="n">binpal</span><span class="p">(</span><span class="n">white_pct</span><span class="p">))</span><span class="w"> </span><span class="o">%&gt;%</span><span class="w">
    </span><span class="n">addLegend</span><span class="p">(</span><span class="s1">'topright'</span><span class="p">,</span><span class="w"> </span><span class="n">pal</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">binpal</span><span class="p">,</span><span class="w"> </span><span class="n">values</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="o">~</span><span class="n">white_pct</span><span class="p">,</span><span class="w">
              </span><span class="n">title</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s1">'% White population (2010)'</span><span class="p">)</span><span class="w">

</span><span class="c1">## show each map</span><span class="w">
</span><span class="n">map_bl_pct</span><span class="w">
</span><span class="n">map_hi_pct</span><span class="w">
</span><span class="n">map_as_pct</span><span class="w">
</span><span class="n">map_wh_pct</span><span class="w">
</span></code></pre></div></div>

<!--html_preserve-->

<iframe src="./maps/maps/map_bl_pct.html">

</iframe>

<!--/html_preserve-->

<!--html_preserve-->

<iframe src="./maps/maps/map_hi_pct.html">

</iframe>

<!--/html_preserve-->

<!--html_preserve-->

<iframe src="./maps/maps/map_as_pct.html">

</iframe>

<!--/html_preserve-->

<!--html_preserve-->

<iframe src="./maps/maps/map_wh_pct.html">

</iframe>

<!--/html_preserve-->

<p>Noting that these maps use older data, show demographic percentages of
residents in the census block (not necessarily element school students),
and rely on some assumptions about how to divide population among
overlapping census blocks, they do suggest demographic differences
across elementary school catchment zones within the city.</p>

<p>The next step would be to link these data with information about each
school from the <a href="https://nces.ed.gov/ccd/pubschuniv.asp">Common Core of
Data</a> or the <a href="http://www.doe.virginia.gov/statistics_reports/index.shtml#">Virginia
Department of
Education</a>
to see whether demographic differences are associated with
characteristics of the schools.</p>

<blockquote>
  <h4 id="not-so-quick-exercise">Not-so-quick exercise</h4>

  <p>Link these findings with school specific data from either the CCD or
VDoE.</p>
</blockquote>

<blockquote>
  <h4 id="even-less-quick-exercise">Even-less-quick exercise</h4>

  <p>Housing data (including assessed value) are available through the
Charlottesville data portal. See if you can download them and map
various housing statistics for each school zone:</p>

  <ol>
    <li>Average assessed value</li>
    <li>Number of single family residences</li>
    <li>Number of multi-family residences (apartment buildings)</li>
  </ol>

  <p><a href="http://www.charlottesville.org/home/showdocument?id=16311">Here’s</a> a
document that will help you make sense of residential codes.</p>
</blockquote>



      </section>
      <footer>
        <p>
  Benjamin Skinner</br>  
  Research Assistant Professor of Education</br>  
  University of Virginia</br>  
  <a href="https://www.btskinner.me" class="iconlink">
    <i class="fas fa-home fa-lg"></i></a> | 
  <a href="https://github.com/btskinner" class="iconlink">
    <i class="fab fa-github fa-lg"></i></a> | 
  <a href="mailto:btskinner@virginia.edu" class="iconlink">
    <i class="far fa-envelope fa-lg"></i></a> | 
  <a href="https://twitter.com/btskinner" class="iconlink">
    <i class="fab fa-twitter fa-lg"></i></a>
</p>
<p><small>Hosted on GitHub Pages &mdash; Theme by <a href="https://github.com/orderedlist">orderedlist</a></small></p>

      </footer>
    </div>
    <script src="/rworkshop/assets/js/scale.fix.js"></script>

    
    
    
    

    
    <script>
        (function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
        (i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
        m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
        })(window,document,'script','https://www.google-analytics.com/analytics.js','ga');
        ga('create', 'UA-63981025-1', 'auto');
        ga('send', 'pageview');
    </script>
  
  </body>
</html>
